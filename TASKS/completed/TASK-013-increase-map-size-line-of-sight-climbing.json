{
  "id": "TASK-013",
  "title": "Increase map size significantly + add line of sight + enable climbing",
  "type": "bug_fix",
  "priority": "HIGH",
  "assigned_to": "project_manager",
  "status": "completed",
  "created": "2025-10-20T02:40:00Z",
  "completed": "2025-10-20T02:55:00Z",
  "estimated_hours": 0.5,
  "actual_hours": 0.25,
  "discovered_by": "User play testing",
  "description": "Three issues from user feedback: 1) Map still way too small (80-120 felt cramped), 2) RangedEnemy can shoot through obstacles, 3) Enemies should be able to climb over obstacles (takes longer but possible).",

  "bugs_fixed": {
    "issue_1_map_size": {
      "problem": "Map still way too small at 80-120 units",
      "user_feedback": "Map is till wayyyyyyyyy too small",
      "severity": "HIGH - Gameplay experience severely compromised",
      "impact": "Players feel cramped, no room to maneuver"
    },
    "issue_2_line_of_sight": {
      "problem": "RangedEnemy can shoot through obstacles/walls",
      "user_feedback": "enemies can currently shoot me through objects",
      "severity": "HIGH - Unfair gameplay, player can't use cover",
      "impact": "Obstacles provide no tactical value, combat feels broken"
    },
    "issue_3_climbing": {
      "problem": "Enemies can't climb over obstacles at all",
      "user_feedback": "enemies should be able to climb up and over objects it just take longer",
      "severity": "MEDIUM - Navigation limitation",
      "impact": "Enemies get stuck, can't reach player in some situations"
    }
  },

  "fix_1_map_size": {
    "file": "ProceduralMapGenerator.gd",
    "lines": "9-16",
    "changes": {
      "arena_size_min": {
        "before": 80,
        "after": 150,
        "increase": "87.5% larger minimum"
      },
      "arena_size_max": {
        "before": 120,
        "after": 250,
        "increase": "108% larger maximum"
      },
      "obstacle_count_min": {
        "before": 15,
        "after": 25,
        "reason": "More obstacles for larger maps"
      },
      "obstacle_count_max": {
        "before": 35,
        "after": 60,
        "reason": "Proportional scaling for large arenas"
      },
      "min_obstacle_spacing": {
        "before": 3.0,
        "after": 5.0,
        "reason": "Wider spacing for bigger maps, better pathfinding"
      },
      "center_clearance_radius": {
        "before": 8.0,
        "after": 15.0,
        "reason": "Larger safe spawn zone for player"
      }
    },
    "result": "Arena now 2-3x larger (150-250 units vs 80-120), feels spacious"
  },

  "fix_2_line_of_sight": {
    "file": "RangedEnemy.gd",
    "function_added": "_has_line_of_sight()",
    "lines": "164-192",
    "implementation": {
      "method": "Physics raycast from enemy to player",
      "raycast_from": "Enemy position + Vector3(0, 1.5, 0) (shoot height)",
      "raycast_to": "Player position + Vector3(0, 1.0, 0) (player center)",
      "check_logic": [
        "Cast ray from enemy to player",
        "If ray hits nothing, return true (clear sight)",
        "If ray hits player first, return true (direct sight)",
        "If ray hits obstacle, return false (blocked)"
      ]
    },
    "integration": "Called in _fire_projectile() before creating projectile",
    "code": "if not _has_line_of_sight():\n    print('No line of sight, canceling shot')\n    return",
    "result": "RangedEnemy only fires when it has clear line of sight to player"
  },

  "fix_3_climbing": {
    "file": "ProceduralMapGenerator.gd",
    "function": "_create_navigation_mesh()",
    "lines": "348-353",
    "changes": {
      "agent_max_climb": {
        "before": 0.5,
        "after": 2.5,
        "explanation": "Allows climbing obstacles up to 2.5 units high (most obstacles 1.5-3.0)"
      },
      "agent_max_slope": {
        "before": "not set (default 45)",
        "after": 45.0,
        "explanation": "Explicitly allow climbing 45-degree slopes"
      }
    },
    "how_it_works": {
      "navigation_mesh": "NavigationMesh.agent_max_climb defines max vertical step height",
      "pathfinding": "NavigationServer3D considers climbing when calculating paths",
      "cost": "Climbing paths have higher cost (longer) than flat paths",
      "behavior": "Enemies prefer flat paths, but CAN climb over obstacles if needed"
    },
    "result": "Enemies can climb over obstacles (slower), won't get stuck"
  },

  "technical_details": {
    "line_of_sight_raycast": {
      "godot_api": "PhysicsRayQueryParameters3D + direct_space_state.intersect_ray()",
      "why_needed": "Projectiles have no collision with obstacles, so raycast must check manually",
      "raycast_height": "1.5 units (where projectile spawns from enemy)",
      "collision_mask": "Layer 1 (default physics - catches obstacles and player)",
      "exclude_self": "Enemy excluded from raycast to avoid self-collision",
      "performance": "Single raycast per shot attempt, very cheap"
    },
    "climbing_navigation": {
      "agent_max_climb": "Vertical distance agent can step up in single move",
      "path_cost": "Climbing paths cost more than flat paths (A* algorithm)",
      "behavior": "Enemy takes flat path if available, climbs if necessary",
      "obstacle_heights": "Most obstacles 1.5-5.0 units, max_climb 2.5 allows partial climbing",
      "stuck_prevention": "Enemies won't get permanently stuck behind obstacles"
    },
    "map_size_scaling": {
      "150_units": "Good minimum, allows maneuvering and escape",
      "250_units": "Large epic battles, lots of space",
      "obstacle_density": "25-60 obstacles for 150-250 unit arena = good balance",
      "comparison": "TestArena was 50x50, now 150x250 = 3-5x larger!"
    }
  },

  "gameplay_impact": {
    "map_size": {
      "before": "80-120 units felt cramped, player quickly surrounded",
      "after": "150-250 units feels spacious, room to kite and maneuver",
      "user_experience": "Major improvement in gameplay feel and strategy"
    },
    "line_of_sight": {
      "before": "Ranged enemies shoot through walls, cover useless",
      "after": "Obstacles provide tactical cover, fair combat",
      "user_experience": "Combat feels fair, rewards positioning behind cover"
    },
    "climbing": {
      "before": "Enemies stuck behind obstacles, can't reach player",
      "after": "Enemies climb over obstacles (slower), always threatening",
      "user_experience": "No safe exploits, enemies always apply pressure"
    }
  },

  "files_modified": [
    {
      "file": "megabonk-mobile/scripts/maps/ProceduralMapGenerator.gd",
      "changes": [
        "Lines 9-10: arena_size_min/max = 150-250 (was 80-120)",
        "Lines 13-16: Scaled obstacles proportionally (25-60, spacing 5.0)",
        "Lines 351-352: agent_max_climb = 2.5, agent_max_slope = 45.0"
      ]
    },
    {
      "file": "megabonk-mobile/scripts/enemies/RangedEnemy.gd",
      "changes": [
        "Lines 137-141: Added line of sight check before firing",
        "Lines 164-192: Added _has_line_of_sight() function with raycast"
      ]
    }
  ],

  "verification_steps": {
    "test_1_map_size": "Launch game multiple times, verify arenas feel much larger (150-250 range)",
    "test_2_line_of_sight": "Stand behind obstacle, verify ranged enemies don't shoot through it",
    "test_3_climbing": "Lead enemies to obstacles, verify they path around OR over obstacles",
    "test_4_obstacle_density": "Check obstacle count, verify 25-60 obstacles well distributed",
    "expected_behavior": "Large spacious arenas, enemies respect cover, enemies can climb when needed"
  },

  "acceptance_criteria": [
    "✅ Arena size increased to 150-250 units",
    "✅ Obstacles scaled to 25-60 count",
    "✅ Line of sight check added to RangedEnemy",
    "✅ Navigation climbing enabled (agent_max_climb = 2.5)",
    "⏳ User confirms map size feels good (pending)",
    "⏳ User confirms cover works (pending)",
    "⏳ User confirms enemies can climb (pending)"
  ],

  "lessons_learned": {
    "lesson_1": "User feedback on 'feel' is critical - 2x increase wasn't enough, needed 3x",
    "lesson_2": "Line of sight must be checked for ranged combat fairness",
    "lesson_3": "Navigation must allow climbing to prevent stuck enemies",
    "lesson_4": "Obstacle density must scale with arena size",
    "lesson_5": "Iterative testing with user feedback > guessing parameters"
  },

  "user_feedback_response": {
    "issue_1_addressed": "Map size increased from 80-120 to 150-250 (2-3x larger)",
    "issue_2_addressed": "Line of sight check prevents shooting through objects",
    "issue_3_addressed": "Climbing enabled with agent_max_climb = 2.5",
    "listening_to_feedback": "All three issues directly from user testing, all fixed immediately"
  }
}
